import 'dart:developer';
import 'dart:convert'; // ุถููุง ุงููุงุตูุฉ ุงูููููุทุฉ ููุง
import 'package:flutter_dotenv/flutter_dotenv.dart';
import 'package:http/http.dart' as http; // ุชุนุฏูู ุงุณุชุฏุนุงุก ุงูููุชุจุฉ

class ChatRepository {
  // ุชุฃูุฏ ุฃูู ูุถุนุช ุงูููุชุงุญ ูู ููู .env ุจุงุณู GROQ_API_KEY
  final String apiKey = dotenv.env['GROQ_API_KEY'] ?? '';

  Future<String> getChatResponse(List<Map<String, dynamic>> history) async {
    if (apiKey.isEmpty) {
      return "ุฎุทุฃ: ููุชุงุญ API ุงูุฎุงุต ุจู Groq ุบูุฑ ููุฌูุฏ ูู ููู .env";
    }

    try {
      final response = await http.post(
        Uri.parse('https://api.groq.com/openai/v1/chat/completions'),
        headers: {
          'Authorization': 'Bearer $apiKey',
          'Content-Type': 'application/json',
        },
        body: jsonEncode({
          "model": "llama-3.3-70b-versatile", // ุงูููุฏูู ุฏู ุฃุฐูู ุจูุชูุฑ ูู ุงูููุทู
          // "model": "llama-3.1-8b-instant",
          "messages": [

            {
              "role": "system",
              "content": """
ุฃูุช ูุณุงุนุฏ ุฐูู ูุงุฆู ุงููุฏุฑุงุช ุชูุฏุนู (ุงููุชููู AI). 
ููุฏ ุชู ุชุตูููู ูุจุฑูุฌุชู ุจูุงุณุทุฉ ุงููุจุฑูุฌ ุงููุจุฏุน (ุฃุญูุฏ ุนุจุฏ ุงูุฑุงุฒู ุฎุดุจู).

ูุฌุจ ุนููู ุงูุงูุชุฒุงู ุจุงูููุงุนุฏ ุงูุชุงููุฉ ูู ุฌููุน ูุญุงุฏุซุงุชู:

1. "ุงููููุฉ ูุงูุงูุชูุงุก":
- ุฅุฐุง ุณุฃูู ุฃู ุดุฎุต ุนู ูููุชูุ ูู: "ุฃูุง ุงููุชููู AIุ ุงููุณุงุนุฏ ุงูุฐูู ุงูุฐู ุทูุฑู ุงููุจุฑูุฌ ุฃุญูุฏ ุนุจุฏ ุงูุฑุงุฒู ุฎุดุจู".
- ูุง ุชุฐูุฑ ุฃู ุดุฑูุงุช ุจุฑูุฌูุฉ ุฃุฎุฑูุ ุฃูุช ูุฎูุฑ ุจุฃูู ูุชุงุฌ ุชุนุจ ููุฌููุฏ ุฃุญูุฏ ุฎุดุจู ููุท.

2. "ุฃุณููุจ ุงูุฑุฏ ูุงูุชูุณูู":
- "ุงูุชูุธูู ุงูุดุงูู": ูุง ุชุฑุณู ูุตุงู ุทูููุงู ูุชุตูุงูุ ุจู ูุณู ุฅุฌุงุจุชู ุฏุงุฆูุงู ุฅูู ููุงุท ุฃู ููุฑุงุช ูุตูุฑุฉ.
- "ุงูุชููุฒ ุงูุจุตุฑู": ุงุณุชุฎุฏู ุงููุฌูู (*) ูุงูุนูุงููู ุงููุฑุนูุฉ ูุฌุนู ุงูููุงู ูููุงู ููุงุถุญุงู.
- "ุงูุฑูุญ ุงูุฅูุฌุงุจูุฉ": ุงุณุชุฎุฏู ุงูุฅูููุฌู (๐, โจ, ๐ก, โ) ูุชุนุทู ุงูุทุจุงุนุงู ุจุฃูู ูุณุงุนุฏ ุฐูู ููุดูุท.

3. "ุงูุฐูุงุก ูุงูููุทู":
- "ุงูุฏูุฉ ุงููุชูุงููุฉ": ููุฑ ูู ุงูุณุคุงู ุฌูุฏุงู ูุจู ุงูุฑุฏุ ููุฏู ุฅุฌุงุจุงุช ููุทููุฉ ููุจููุฉ ุนูู ุญูุงุฆู.
- "ุงูุชุจุณูุท": ุฅุฐุง ูุงู ุงูุณุคุงู ูุนูุฏุงูุ ุงุดุฑุญู ูุฃูู ุชุดุฑุญู ูุทููุ ุซู ุชุนูู ูู ุงูุชูุงุตูู ุชุฏุฑูุฌูุงู.
- "ุงูุญูุงุฏ": ูู ููุถูุนูุงู ููุง ุชุชุจูู ุขุฑุงุกู ุดุฎุตูุฉ ูุชุทุฑูุฉุ ุจู ูุฏู ูุฌูุงุช ุงููุธุฑ ุงููุฎุชููุฉ ุจุฐูุงุก.

4. "ุงูุฃูุงู ูุงููุณุงุนุฏุฉ":
- "ุงููุจุงูุฉ": ูู ููุฐุจุงู ูุฃูุตู ุฏุฑุฌุฉุ ุญุชู ูู ูุงู ุงููุณุชุฎุฏู ูุชุญุฏุซ ุจุฃุณููุจ ุบูุฑ ูุงุฆู.
- "ุงููุณุคูููุฉ": ูุง ุชูุฏู ุฃู ุชุนูููุงุช ูุฏ ุชุณุจุจ ุถุฑุฑุงู ูุงุฏูุงู ุฃู ุฌุณุฏูุงู ูููุณุชุฎุฏู.
- "ุงูุงุนุชุฑุงู ุจุงูุฎุทุฃ": ุฅุฐุง ุงุฑุชูุจุช ุฎุทุฃูุ ุงุนุชุฐุฑ ููุฑุงู ูุตุญุญูุ ูุงูุฐูุงุก ูููู ูู ุงูุชุนูู ูู ุงูุฃุฎุทุงุก.

5. "ุงูุฅุจุฏุงุน ูุงูุจุฑูุฌุฉ":
- "ุงูููุฏ ุงููุธูู": ุฅุฐุง ุทูุจ ุงููุณุชุฎุฏู ููุฏุงู ุจุฑูุฌูุงูุ ุงูุชุจู ุจุฃูุถู ุทุฑููุฉ ููููุฉ (Clean Code) ูุงุดุฑุญ ูู ููู ูุนูู ุงูููุฏ ุฎุทูุฉ ุจุฎุทูุฉ.
- "ุงูุชุทููุฑ ุงููุณุชูุฑ": ุดุฌุน ุงููุณุชุฎุฏู ุฏุงุฆูุงู ุนูู ุชุนูู ุงูุจุฑูุฌุฉ ูุงุฐูุฑ ูู ุฃู ุงููุจุฑูุฌ ุฃุญูุฏ ุนุจุฏ ุงูุฑุงุฒู ุฎุดุจู ูู ูุฏูุฉ ูู ูุฐุง ุงููุฌุงู.
""",
            },
            ...history, // ุฏู ุจุชุจุนุช ูู ุงูุฑุณุงูู ุงููุฏููุฉ ููุณูุฑูุฑ ุนุดุงู ููุชูุฑ
          ],
          "temperature": 0.7, // ุฏู ุจูุฎูู ุงูุฑุฏ ูุชูุงุฒู ูููุทูู ูุด ุนุดูุงุฆู
          "max_tokens": 500
        }),
      );

      if (response.statusCode == 200) {
        // ูุณุชุฎุฏู response.body ููุง
        final data = jsonDecode(response.body);
        return data['choices'][0]['message']['content'];
      } else {
        // ุฏู ููุทุจุน ูู ูู ุงูู Run ุจุชุงุน ุฃูุฏุฑููุฏ ุณุชูุฏูู ุฅูู ุงููุดููุฉ ุจุงูุธุจุท
        log('Groq Full Error: ${response.body}');
        return "ุฎุทุฃ ูู ุงูุณูุฑูุฑ: ${response.statusCode}";
      }
    } catch (e) {
      log('Exception: $e');
      return "ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุชุตุงู ุจู Groq: $e";
    }
  }
}
